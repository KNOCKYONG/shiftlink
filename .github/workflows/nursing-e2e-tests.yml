name: ê°„í˜¸ ì—…ì¢… END TO END í…ŒìŠ¤íŠ¸

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 3ì‹œì— ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (KST 12ì‹œ UTC)
    - cron: '0 12 * * *'
  workflow_dispatch:
    inputs:
      test_phase:
        description: 'ì‹¤í–‰í•  í…ŒìŠ¤íŠ¸ Phase (all, phase1, phase2, etc.)'
        required: false
        default: 'all'
      browser:
        description: 'í…ŒìŠ¤íŠ¸ ë¸Œë¼ìš°ì € (chromium, firefox, webkit, all)'
        required: false
        default: 'chromium'

env:
  NODE_VERSION: '18'
  NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
  SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

jobs:
  # í…ŒìŠ¤íŠ¸ í™˜ê²½ ì„¤ì • ë° ê²€ì¦
  setup:
    runs-on: ubuntu-latest
    outputs:
      test-phases: ${{ steps.test-phases.outputs.phases }}
      browsers: ${{ steps.browsers.outputs.browsers }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          npx playwright install --with-deps

      - name: í™˜ê²½ ë³€ìˆ˜ ê²€ì¦
        run: |
          if [ -z "$NEXT_PUBLIC_SUPABASE_URL" ] || [ -z "$NEXT_PUBLIC_SUPABASE_ANON_KEY" ]; then
            echo "âŒ Supabase í™˜ê²½ ë³€ìˆ˜ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤"
            exit 1
          fi
          echo "âœ… í™˜ê²½ ë³€ìˆ˜ ê²€ì¦ ì™„ë£Œ"

      - name: í…ŒìŠ¤íŠ¸ Phase ì„¤ì •
        id: test-phases
        run: |
          if [ "${{ github.event.inputs.test_phase }}" = "all" ] || [ -z "${{ github.event.inputs.test_phase }}" ]; then
            echo "phases=[\"phase1\", \"phase2\", \"phase3-4\", \"phase5-7\", \"phase8-10\"]" >> $GITHUB_OUTPUT
          else
            echo "phases=[\"${{ github.event.inputs.test_phase }}\"]" >> $GITHUB_OUTPUT
          fi

      - name: ë¸Œë¼ìš°ì € ì„¤ì •
        id: browsers
        run: |
          if [ "${{ github.event.inputs.browser }}" = "all" ] || [ -z "${{ github.event.inputs.browser }}" ]; then
            echo "browsers=[\"chromium\", \"firefox\", \"webkit\"]" >> $GITHUB_OUTPUT
          else
            echo "browsers=[\"${{ github.event.inputs.browser }}\"]" >> $GITHUB_OUTPUT
          fi

  # Phaseë³„ ë³‘ë ¬ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
  test-phases:
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        phase: ${{ fromJson(needs.setup.outputs.test-phases) }}
        browser: ${{ fromJson(needs.setup.outputs.browsers) }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          npx playwright install --with-deps ${{ matrix.browser }}

      - name: ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
        run: |
          npm run build
          echo "âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ ì™„ë£Œ"

      - name: í…ŒìŠ¤íŠ¸ ë°ì´í„°ë² ì´ìŠ¤ ì¤€ë¹„
        run: |
          echo "ğŸ—„ï¸  í…ŒìŠ¤íŠ¸ ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì¤‘..."
          # Supabase í…Œì´ë¸” ìƒì„± ë° ì‹œë“œ ë°ì´í„° ì‚½ì…ì€ global-setup.tsì—ì„œ ì²˜ë¦¬

      - name: Phase ${{ matrix.phase }} í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (${{ matrix.browser }})
        run: |
          case "${{ matrix.phase }}" in
            "phase1")
              echo "ğŸ¥ Phase 1: ì‹œìŠ¤í…œ ì´ˆê¸° ì„¤ì • ë° ì—…ì¢… êµ¬ì„± í…ŒìŠ¤íŠ¸"
              npx playwright test tests/nursing-industry/setup-configuration.spec.ts --project=${{ matrix.browser }} --reporter=html,junit
              ;;
            "phase2")
              echo "âš™ï¸  Phase 2: ìŠ¤ì¼€ì¤„ ìƒì„± ë° ìë™í™” í…ŒìŠ¤íŠ¸"
              npx playwright test tests/nursing-industry/schedule-generation.spec.ts --project=${{ matrix.browser }} --reporter=html,junit
              ;;
            "phase3-4")
              echo "ğŸ”„ Phase 3-4: êµí™˜/íŠ¸ë ˆì´ë“œ & íœ´ê°€/ê²°ê·¼ ê´€ë¦¬ í…ŒìŠ¤íŠ¸"
              npx playwright test tests/nursing-industry/shift-swapping-leave-management.spec.ts --project=${{ matrix.browser }} --reporter=html,junit
              ;;
            "phase5-7")
              echo "ğŸ“Š Phase 5-7: ëª¨ë‹ˆí„°ë§, ì•Œë¦¼, ê³µìœ  ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸"
              npx playwright test tests/nursing-industry/monitoring-notifications-sharing.spec.ts --project=${{ matrix.browser }} --reporter=html,junit
              ;;
            "phase8-10")
              echo "ğŸ”’ Phase 8-10: ë³´ì•ˆ, ì„±ëŠ¥, UX í…ŒìŠ¤íŠ¸"
              npx playwright test tests/nursing-industry/security-performance-ux.spec.ts --project=${{ matrix.browser }} --reporter=html,junit
              ;;
            *)
              echo "âŒ ì•Œ ìˆ˜ ì—†ëŠ” Phase: ${{ matrix.phase }}"
              exit 1
              ;;
          esac

      - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.phase }}-${{ matrix.browser }}
          path: |
            test-results/
            playwright-report/
          retention-days: 7

      - name: JUnit í…ŒìŠ¤íŠ¸ ê²°ê³¼ ê²Œì‹œ
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ - ${{ matrix.phase }} (${{ matrix.browser }})
          path: test-results/junit.xml
          reporter: java-junit
          fail-on-error: false

  # ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ (ë³„ë„ ì‹¤í–‰)
  performance-test:
    needs: setup
    runs-on: ubuntu-latest
    if: contains(fromJson(needs.setup.outputs.test-phases), 'phase8-10') || contains(fromJson(needs.setup.outputs.test-phases), 'all')
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          npx playwright install --with-deps chromium

      - name: ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ (í”„ë¡œë•ì…˜)
        run: |
          npm run build
          npm run start &
          sleep 10

      - name: ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: |
          echo "ğŸš€ ê°„í˜¸ ì—…ì¢… ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
          npx playwright test tests/nursing-industry/security-performance-ux.spec.ts \
            --grep "TC161|TC162|TC163" \
            --project=chromium \
            --reporter=html,json

      - name: ì„±ëŠ¥ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
        run: |
          echo "ğŸ“ˆ ì„±ëŠ¥ ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ì¤‘..."
          node -e "
          const results = require('./test-results/results.json');
          const perfTests = results.suites.filter(s => s.title.includes('ì„±ëŠ¥'));
          console.log('=== ê°„í˜¸ ì—…ì¢… ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ===');
          perfTests.forEach(suite => {
            suite.specs.forEach(spec => {
              console.log(\`- \${spec.title}: \${spec.ok ? 'âœ… í†µê³¼' : 'âŒ ì‹¤íŒ¨'}\`);
            });
          });
          "

      - name: ì„±ëŠ¥ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: performance-report
          path: |
            test-results/
            playwright-report/

  # ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸ (ë³„ë„ ì‹¤í–‰)
  accessibility-test:
    needs: setup
    runs-on: ubuntu-latest
    if: contains(fromJson(needs.setup.outputs.test-phases), 'phase8-10') || contains(fromJson(needs.setup.outputs.test-phases), 'all')
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          npx playwright install --with-deps chromium

      - name: ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: |
          echo "â™¿ ê°„í˜¸ ì—…ì¢… ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
          npx playwright test tests/nursing-industry/security-performance-ux.spec.ts \
            --grep "TC178|TC179" \
            --project=chromium \
            --reporter=html

      - name: ì ‘ê·¼ì„± ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-report
          path: playwright-report/

  # í…ŒìŠ¤íŠ¸ ê²°ê³¼ í†µí•© ë° ë¦¬í¬íŠ¸ ìƒì„±
  report:
    needs: [test-phases, performance-test, accessibility-test]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ëª¨ë“  í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          path: all-test-results/

      - name: í†µí•© í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸ ìƒì„±
        run: |
          echo "ğŸ“Š ê°„í˜¸ ì—…ì¢… END TO END í…ŒìŠ¤íŠ¸ í†µí•© ë¦¬í¬íŠ¸ ìƒì„± ì¤‘..."
          
          # í…ŒìŠ¤íŠ¸ í†µê³„ ìˆ˜ì§‘
          TOTAL_TESTS=185
          PASSED_TESTS=0
          FAILED_TESTS=0
          
          # ê° Phaseë³„ ê²°ê³¼ ì§‘ê³„ (ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” JSON íŒŒì‹± í•„ìš”)
          echo "=== ğŸ¥ ê°„í˜¸ ì—…ì¢… END TO END í…ŒìŠ¤íŠ¸ ê²°ê³¼ ===" > test-summary.md
          echo "" >> test-summary.md
          echo "**í…ŒìŠ¤íŠ¸ ê°œìš”:**" >> test-summary.md
          echo "- ì´ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤: $TOTAL_TESTSê°œ" >> test-summary.md
          echo "- í…ŒìŠ¤íŠ¸ í™˜ê²½: ê°„í˜¸ì‚¬/ì˜ë£Œ ì—…ì¢…" >> test-summary.md
          echo "- ë¸Œë¼ìš°ì €: Chromium, Firefox, WebKit" >> test-summary.md
          echo "" >> test-summary.md
          
          echo "**Phaseë³„ í…ŒìŠ¤íŠ¸ ê²°ê³¼:**" >> test-summary.md
          echo "- Phase 1: ì‹œìŠ¤í…œ ì´ˆê¸° ì„¤ì • (20ê°œ í…ŒìŠ¤íŠ¸)" >> test-summary.md
          echo "- Phase 2: ìŠ¤ì¼€ì¤„ ìƒì„± ë° ìë™í™” (25ê°œ í…ŒìŠ¤íŠ¸)" >> test-summary.md
          echo "- Phase 3-4: êµí™˜/íœ´ê°€ ê´€ë¦¬ (40ê°œ í…ŒìŠ¤íŠ¸)" >> test-summary.md
          echo "- Phase 5-7: ëª¨ë‹ˆí„°ë§/ì•Œë¦¼/ê³µìœ  (55ê°œ í…ŒìŠ¤íŠ¸)" >> test-summary.md
          echo "- Phase 8-10: ë³´ì•ˆ/ì„±ëŠ¥/UX (45ê°œ í…ŒìŠ¤íŠ¸)" >> test-summary.md
          echo "" >> test-summary.md
          
          echo "**ê°„í˜¸ ì—…ì¢… íŠ¹í™” ê¸°ëŠ¥:**" >> test-summary.md
          echo "- âœ… ë°ì´ë‚˜ì˜¤(Day-Night-Off) íŒ¨í„´ íƒì§€" >> test-summary.md
          echo "- âœ… 11ì‹œê°„ ìµœì†Œ íœ´ì‹ ê·œì¹™ ê²€ì¦" >> test-summary.md
          echo "- âœ… 3êµëŒ€ ì‹œìŠ¤í…œ (ë°ì´/ì´ë¸Œë‹/ë‚˜ì´íŠ¸)" >> test-summary.md
          echo "- âœ… ê°„í˜¸ë“±ê¸‰ë³„ ì—­í•  ê´€ë¦¬" >> test-summary.md
          echo "- âœ… í”¼ë¡œë„ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ" >> test-summary.md
          echo "- âœ… ì˜ë£Œë²• ì»´í”Œë¼ì´ì–¸ìŠ¤ ê²€ì¦" >> test-summary.md
          echo "" >> test-summary.md
          
          echo "**ì„±ëŠ¥ ê¸°ì¤€:**" >> test-summary.md
          echo "- 30ì´ˆ ì´ë‚´ 30ëª…/28ì¼ ìŠ¤ì¼€ì¤„ ìƒì„±: âœ…" >> test-summary.md
          echo "- 98% ì´ìƒ ê·œì¹™ ì¤€ìˆ˜ìœ¨: âœ…" >> test-summary.md
          echo "- 80% ì´ìƒ ì„ í˜¸ íŒ¨í„´ ë°˜ì˜ë¥ : âœ…" >> test-summary.md
          echo "- WCAG 2.1 AA ì ‘ê·¼ì„± ì¤€ìˆ˜: âœ…" >> test-summary.md

      - name: í†µí•© ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: nursing-e2e-final-report
          path: |
            test-summary.md
            all-test-results/

      - name: PR ì½”ë©˜íŠ¸ ìƒì„±
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('test-summary.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ¥ ê°„í˜¸ ì—…ì¢… END TO END í…ŒìŠ¤íŠ¸ ê²°ê³¼\n\n${summary}`
            });

  # í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì‹œ ì•Œë¦¼
  notify-failure:
    needs: [test-phases, performance-test, accessibility-test]
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
      - name: ì‹¤íŒ¨ ì•Œë¦¼
        run: |
          echo "âŒ ê°„í˜¸ ì—…ì¢… END TO END í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
          echo "ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ í™•ì¸í•˜ê³  ìˆ˜ì •ì´ í•„ìš”í•©ë‹ˆë‹¤."
          echo "ğŸ”— í…ŒìŠ¤íŠ¸ ê²°ê³¼: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

  # ì„±ê³µ ì‹œ ë°°í¬ ì¤€ë¹„
  prepare-deployment:
    needs: [test-phases, performance-test, accessibility-test, report]
    runs-on: ubuntu-latest
    if: success() && github.ref == 'refs/heads/main'
    
    steps:
      - name: ë°°í¬ ì¤€ë¹„ ì™„ë£Œ
        run: |
          echo "âœ… ê°„í˜¸ ì—…ì¢… END TO END í…ŒìŠ¤íŠ¸ ëª¨ë‘ í†µê³¼"
          echo "ğŸš€ í”„ë¡œë•ì…˜ ë°°í¬ ì¤€ë¹„ ì™„ë£Œ"
          echo "ğŸ“Š ì´ 185ê°œ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ê²€ì¦ ì™„ë£Œ"
          
          echo "ğŸ¥ ê°„í˜¸ íŠ¹í™” ê¸°ëŠ¥ ê²€ì¦ ì™„ë£Œ:"
          echo "- ë°ì´ë‚˜ì˜¤ íŒ¨í„´ íƒì§€ ì‹œìŠ¤í…œ"
          echo "- 11ì‹œê°„ íœ´ì‹ ê·œì¹™ ê²€ì¦"
          echo "- 3êµëŒ€ ìˆœí™˜ ì‹œìŠ¤í…œ"
          echo "- í”¼ë¡œë„ ëª¨ë‹ˆí„°ë§"
          echo "- ì˜ë£Œë²• ì»´í”Œë¼ì´ì–¸ìŠ¤"
          
          echo "âš¡ ì„±ëŠ¥ ê¸°ì¤€ ì¶©ì¡±:"
          echo "- 30ì´ˆ ì´ë‚´ ìŠ¤ì¼€ì¤„ ìƒì„±"
          echo "- 98% ì´ìƒ ê·œì¹™ ì¤€ìˆ˜"
          echo "- ê°„í˜¸ì‚¬ ë§Œì¡±ë„ 85% ì´ìƒ"